<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.3">
<meta name="author" content="Pepper Lebeck-Jobe">
<title>Building Java 9 Modules</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
<link rel="stylesheet" href="https://guides.gradle.org/css/asciidoctor.css">
<link rel="stylesheet" href="https://guides.gradle.org/css/styles.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,700|Source+Code+Pro:500">
<link rel="apple-touch-icon" sizes="180x180" href="https://guides.gradle.org/icon/apple-touch-icon.png">
<link rel="icon" type="image/png" href="https://guides.gradle.org/icon/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://guides.gradle.org/icon/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="https://guides.gradle.org/icon/manifest.json">
<link rel="mask-icon" href="https://guides.gradle.org/icon/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="https://guides.gradle.org/icon/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Building Java 9 Modules">
<meta name="application-name" content="Building Java 9 Modules">
<meta name="msapplication-config" content="https://guides.gradle.org/icon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<script defer src="https://guides.gradle.org/js/set-time-to-complete-text.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,"script","https://www.google-analytics.com/analytics.js","ga");
  ga("create", "UA-4207603-1", "auto");
  ga("send", "pageview");
</script>
</head>
<body class="article toc2 toc-right">
<div id="header"><div style="padding-top: 10px;"><a href="https://guides.gradle.org"><img src="https://guides.gradle.org/gradle-guides.svg" alt=""></a></div><h1>Building Java 9 Modules</h1>
<div class="details">
<span id="author" class="author">Pepper Lebeck-Jobe</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#what_you_ll_learn">What you&#8217;ll learn</a></li>
<li><a href="#what_you_ll_need">What you&#8217;ll need</a></li>
<li><a href="#understanding_the_example_project">Understanding the Example Project</a></li>
<li><a href="#step_1_produce_a_java_9_module_for_a_single_subproject">Step 1 - Produce a Java 9 module for a single subproject</a></li>
<li><a href="#step_2_produce_java_9_modules_for_all_subprojects">Step 2 - Produce Java 9 modules for all subprojects</a></li>
<li><a href="#step_3_consume_java_9_modules_in_the_code_run_code_and_code_assemble_code_tasks">Step 3 - Consume Java 9 modules in the <code>run</code> and <code>assemble</code> tasks</a></li>
<li><a href="#step_4_use_the_code_experimental_jigsaw_code_plugin_to_do_the_same_thing">Step 4 - Use the <code>experimental-jigsaw</code> plugin to do the same thing</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#help_improve_this_guide">Help improve this guide</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="what_you_ll_learn"><a class="anchor" href="#what_you_ll_learn"></a>What you&#8217;ll learn</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the most exciting features of Java 9 is its support for developing and
deploying modular Java software. In this guide, you&#8217;ll learn exactly what you
need to change in your Java application to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>produce Java 9 modules for your java libraries.</p>
</li>
<li>
<p>consume Java 9 modules as your dependencies.</p>
</li>
<li>
<p>use Java&#8217;s <code>ServiceLoader</code> pattern with Java 9 modules.</p>
</li>
<li>
<p>run an application using Java 9 modules.</p>
</li>
<li>
<p>use an experimental plugin to do all of this more simply.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While Gradle version 4.2 doesn&#8217;t have first-class support for
Java 9 modules yet, this guide shows you how to experiment with them before that
support is complete.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what_you_ll_need"><a class="anchor" href="#what_you_ll_need"></a>What you&#8217;ll need</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>About <span class="time-to-complete-text">60 minutes</span></p>
</li>
<li>
<p>A text editor</p>
</li>
<li>
<p>A command prompt</p>
</li>
<li>
<p>The Java Development Kit (JDK), version 1.9 (build 174) or newer</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding_the_example_project"><a class="anchor" href="#understanding_the_example_project"></a>Understanding the Example Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide explains step-by-step how to convert an example Java application
which doesn&#8217;t use any Java 9 features into a fully-modular Java 9 application.
The source code for the original version of the application lives in the
<code>src/0-original</code> directory. It is organized as multi-project Gradle build made
up of six subprojects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fairy</code> - The entry point to the storyteller java application.</p>
</li>
<li>
<p><code>tale</code> - A library which defines the public <code>Tale</code> interface.</p>
</li>
<li>
<p><code>formula</code> - A library which makes it easy to weave a <code>Tale</code>.</p>
</li>
<li>
<p><code>actors</code> - A library which represents the characters in a fairy tale.</p>
</li>
<li>
<p><code>pigs</code> - A library which produces an instance of <code>Tale</code> which represents the
story of the three little pigs.</p>
</li>
<li>
<p><code>bears</code> - A library which produces an instance of <code>Tale</code> which represents the
story of Goldilocks and the three bears.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The project hierarchy showing the dependency relationships between the six
projects can be seen in the following illustration:</p>
</div>
<div id="fig-1" class="imageblock">
<div class="content">
<img src="images/project-graph.png" alt="Project Graph">
</div>
<div class="title">Figure 1: Project Graph</div>
</div>
<div class="paragraph">
<p>If the <code>api</code> and <code>implementation</code> configurations are new to you, read more
about the
<a href="https://docs.gradle.org/current/userguide/java_library_plugin.html">Java Library Plugin</a>
added in Gradle 3.5.</p>
</div>
<div class="paragraph">
<p>You can clone the project and run the original program to see its output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git clone https://github.com/gradle-guides/building-java-9-modules.git
$ cd building-java-9-modules/src/0-original
$ ./gradlew run

&gt; Task :fairy:run
Once upon a time, there lived the big bad wolf, and the 3 little pigs.

&lt;... elided ...&gt;

Goldilocks ran out of the house at top speed to escape the 3 bears.
And they all lived happily ever after.


BUILD SUCCESSFUL</pre>
</div>
</div>
<div class="paragraph">
<p>Before you start modifying this project to have it use Java 9 modules, you need
to understand two important details of how the project is structured. Namely,
that it uses the
<a href="https://docs.oracle.com/javase/7/docs/api/java/util/ServiceLoader.html">ServiceLoader</a>
api to load the fairy tales at runtime, and that it contains a test class that
shows how software modularity was broken before Java 9.</p>
</div>
<div class="sect2">
<h3 id="serviceloader_usage"><a class="anchor" href="#serviceloader_usage"></a>ServiceLoader usage</h3>
<div class="paragraph">
<p>Java 1.6 introduced a simple mechanism for binding a set of implementations of
some interface (the "Service") to a consuming class at runtime. Oracle&#8217;s
<a href="https://docs.oracle.com/javase/tutorial/ext/basics/spi.html">tutorial</a> on the
topic is a bit lengthy, but here&#8217;s how it is used in our sample application:</p>
</div>
<div class="listingblock">
<div class="title">fairy/src/main/java/org/gradle/fairy/app/StoryTeller.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        ServiceLoader&lt;Tale&gt; loader = ServiceLoader.load(Tale.class);
        <span class="keyword">if</span> (!loader.iterator().hasNext()) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Alas, I have no tales to tell!</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">for</span> (Tale tale : loader) {
            tale.tell();
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ServiceLoader</code> coordinates with the JVM&#8217;s ClassLoader to find instances of
the <code>Tale</code> class which have been specified in special files named
<code>org.gradle.fairy.tale.Tale</code> in <code>META-INF/services</code> folders on the classpath.</p>
</div>
<div class="listingblock">
<div class="title">bears/src/main/resources/META-INF/services/org.gradle.fairy.tale.Tale</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">org.gradle.fairy.tale.bears.GoldilocksAndTheThreeBears</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pigs/src/main/resources/META-INF/services/org.gradle.fairy.tale.Tale</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">org.gradle.fairy.tale.pigs.ThreeLittlePigs</code></pre>
</div>
</div>
<div class="paragraph">
<p>Loading these instances at runtime gives the <code>StoryTeller</code> class the loosest
possible coupling to the two libraries which implement the <code>Tale</code> interface.
You can see this in the <code>dependencies</code> block of the <code>build.gradle</code> file for the
application.</p>
</div>
<div class="listingblock">
<div class="title">fairy/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    implementation project(<span class="string"><span class="delimiter">'</span><span class="content">:tale</span><span class="delimiter">'</span></span>)

    runtimeOnly project(<span class="string"><span class="delimiter">'</span><span class="content">:pigs</span><span class="delimiter">'</span></span>)
    runtimeOnly project(<span class="string"><span class="delimiter">'</span><span class="content">:bears</span><span class="delimiter">'</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In fact, comment out both of the lines that start with <code>runtimeOnly</code> and notice how the output of Gradle&#8217;s <code>run</code> task changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./gradlew run

&gt; Task :fairy:run
Alas, I have no tales to tell!


BUILD SUCCESSFUL</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modularitytest_discussion"><a class="anchor" href="#modularitytest_discussion"></a>ModularityTest discussion</h3>
<div class="paragraph">
<p>In the original project, there is a test class which attempts to highlight some
of the problems with how modularity wasn&#8217;t enforced in Java versions prior to 9.</p>
</div>
<div class="listingblock">
<div class="title">formula/src/test/java/org/gradle/fairy/tale/formula/ModularityTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> canReachActor() {
        Actor actor = Imagination.createActor(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sean Connery</span><span class="delimiter">&quot;</span></span>);
        assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sean Connery</span><span class="delimiter">&quot;</span></span>, actor.toString());
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> canDynamicallyReachDefaultActor() <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">Class</span> clazz = ModularityTest
            .class.getClassLoader()
            .loadClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.gradle.actors.impl.DefaultActor</span><span class="delimiter">&quot;</span></span>);
        Actor actor = (Actor) clazz.getConstructor(<span class="predefined-type">String</span>.class)
            .newInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">Kevin Costner</span><span class="delimiter">&quot;</span></span>);
        assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">Kevin Costner</span><span class="delimiter">&quot;</span></span>, actor.toString());
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> canReachDefaultActor() {
        Actor actor = <span class="keyword">new</span> org.gradle.actors.impl.DefaultActor(<span class="string"><span class="delimiter">&quot;</span><span class="content">Kevin Costner</span><span class="delimiter">&quot;</span></span>);
        assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">Kevin Costner</span><span class="delimiter">&quot;</span></span>, actor.toString());
    }

    <span class="comment">/*
    @Test
    public void canReachGuavaClasses() {
        // This line would throw a compiler error because gradle has kept the implementation dependency &quot;guava&quot;
        // from leaking into the formula project.
        Set&lt;String&gt; strings = com.google.common.collect.ImmutableSet.of(&quot;Hello&quot;, &quot;Goodbye&quot;);
        assertTrue(strings.contains(&quot;Hello&quot;));
        assertTrue(strings.contains(&quot;Goodbye&quot;));
    }
    */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The four tests in this class serve different purposes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>canReachActor</code> - Shows appropriate access by a class in the <code>formula</code>
subproject using classes exposed as part of the <code>actors</code> project&#8217;s public
api. This test should always pass.</p>
</li>
<li>
<p><code>canDynamicallyReachDefaultActor</code> - Attempts to use reflection at runtime
to load a class which is private to the <code>actors</code> subproject. This was
possible before Java 9 because the classpath leaks the implementation details
of all parts of the application to all other parts of the application.</p>
</li>
<li>
<p><code>canReachDefaultActor</code> - Attempts to use a class which is private to the
<code>actors</code> subproject directly. This will work before Java 9 because the
private implementation details of the <code>actors</code> subproject are built in the
same location as the public api of that subproject. So, they are available
at compile-time and at runtime.</p>
</li>
<li>
<p><code>canReachGuavaClasses</code> - Attempts to use a class which is a transitive
dependency of the <code>actors</code> subproject. However, since Gradle 3.4, these
<code>implementation</code> dependencies are not included on the <code>compileClasspath</code> of
the consumers of Java projects. So, this test is commented out because it
wouldn&#8217;t compile with Gradle 3.4 and newer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you progress through this guide, you&#8217;ll see that Java 9 modules tighten down
inappropriate access to implementation details of the module, and cause tests
like <code>canDynamicallyReachDefaultActor</code> and <code>canReachDefaultActor</code> to fail at
runtime and not compile, respectively.</p>
</div>
<div class="paragraph">
<p>You can run Gradle&#8217;s <code>check</code> task to see that the three tests pass for the
<code>0-original</code> project (even though two of them are breaking good modular design.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./gradlew check

BUILD SUCCESSFUL</pre>
</div>
</div>
<div class="paragraph">
<p>You can view the results of an invocation of Gradle&#8217;s <code>check</code> task at
<a href="https://scans.gradle.com/s/l76lgbuizu4pm/tests/byProject?toggled=W1sxXSxbMSwwXSxbMSwwLDBdLFsxLDAsMCwwXV0%3D">this build scan.</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_1_produce_a_java_9_module_for_a_single_subproject"><a class="anchor" href="#step_1_produce_a_java_9_module_for_a_single_subproject"></a>Step 1 - Produce a Java 9 module for a single subproject</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you aren&#8217;t already familiar with the Java 9 module system, you should read:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://openjdk.java.net/projects/jigsaw/quick-start">Module System Quick-Start Guide</a> (at least)</p>
</li>
<li>
<p><a href="http://openjdk.java.net/projects/jigsaw/spec/sotms/">The State of The Module System</a> (for more details)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guide assumes that you already have familiarity with the following concepts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The module path</p>
</li>
<li>
<p>Automatic modules</p>
</li>
<li>
<p>The basic syntax of <code>module-info.java</code> files</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One nice feature of the module system in Java 9, is that you can convert all
of the libraries of your project to Java 9 modules in a bottom-up fashion.
Since Java 9 module jars can be consumed equally well from the classpath or the
module path, we can convert a single leaf-node in our multi-project build to
produce a Java 9 module, but use that module jar on the classpath when
compiling or running projects which consume the outputs of that node.</p>
</div>
<div class="paragraph">
<p>When converting a <code>java-library</code> project to produce a Java 9 module, there are
five changes you should to make to your project.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a <code>module-info.java</code> describing the module.</p>
</li>
<li>
<p>Modify the <code>compileJava</code> task to produce a module.</p>
</li>
<li>
<p>Modify the <code>compileTestJava</code> task to locally alter the module.</p>
</li>
<li>
<p>Modify the <code>test</code> task to consume the locally altered module.</p>
</li>
<li>
<p>(Optional) Add <code>Automatic-Module-Name</code> manifest entries for all other
projects.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We recommend proactively adding an <code>Automatic-Module-Name</code> manifest entry in the
<code>META-INF/MANIFEST.MF</code> file for all of the projects which make up your
application. Providing an <code>Automatic-Module-Name</code> allows library authors to
reserve a module name for the future, without having to actually convert the
library to a module. This ensures that consumers of the library know right now
what the module name will be in the future. Doing this is described in the
optional 5th change.</p>
</div>
<div class="paragraph">
<p>Each of these changes is described in subsections below along with discussion
of why the change is being made. You can also view the results of these
changes by exploring the <code>src/1-single-module</code> example project in the
repository.</p>
</div>
<div class="paragraph">
<p>Our goal in making the following five changes is to have the <code>actors</code> project
produce a Java 9 module. The first four changes need to be made together, and
the fifth (optional) change can be made independently.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As a reminder, all builds from this point on need to run on Java 9.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="add_a_code_module_info_java_code_describing_the_module"><a class="anchor" href="#add_a_code_module_info_java_code_describing_the_module"></a>Add a <code>module-info.java</code> describing the module.</h3>
<div class="paragraph">
<p>Add a <code>module-info.java</code> file to the project&#8217;s <code>actors/src/main/java</code> directory.</p>
</div>
<div class="listingblock">
<div class="title">actors/src/main/java/module-info.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">module org.gradle.actors {
    exports org.gradle.actors;
    requires guava;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This file declares the <code>org.gradle.actors</code> module which exports the
<code>org.gradle.actors</code> package (but not the <code>org.gradle.actors.impl</code> package) and
requires the <code>guava</code> module. The Guava jar files are not yet Java 9 modules,
so when you require them, you have to use the automatic module name <code>guava</code>
which the JVM infers from the filename of the jar file which contains the
classes. For Guava, the jar file&#8217;s name is
<a href="http://central.maven.org/maven2/com/google/guava/guava/22.0/">guava-22.0.jar</a>, so according to the
<a href="http://openjdk.java.net/projects/jigsaw/spec/sotms/#automatic-modules">rules of automatic module names</a>,
you require <code>guava</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="modify_the_code_compilejava_code_task_to_produce_a_module"><a class="anchor" href="#modify_the_code_compilejava_code_task_to_produce_a_module"></a>Modify the <code>compileJava</code> task to produce a module.</h3>
<div class="paragraph">
<p>In the <code>build.gradle</code> file for the <code>actors</code> subproject, add the following.</p>
</div>
<div class="listingblock">
<div class="title">actors/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ext.moduleName = <span class="string"><span class="delimiter">'</span><span class="content">org.gradle.actors</span><span class="delimiter">'</span></span> <i class="conum" data-value="1"></i><b>(1)</b>

compileJava {
    inputs.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">moduleName</span><span class="delimiter">&quot;</span></span>, moduleName)
    doFirst {
        options.compilerArgs = [
            <span class="string"><span class="delimiter">'</span><span class="content">--module-path</span><span class="delimiter">'</span></span>, classpath.asPath,
        ]
        classpath = files()  <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Defines a variable for the module name, which allows you to
reuse the same code later for other modules without having to change it.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Clears the <code>classpath</code> property by creating an empty file collection</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When compiling a Java 9 module, you want to use <code>--module-path</code> instead of
<code>--classpath</code> to read your dependencies. So in the <code>doFirst</code> block, you are
clearing out the <code>classpath</code> property of the task and adding a compiler
argument.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--module-path</code> is set to the value that would have been the <code>classpath</code>. This
makes sense because the classpath already has any jars or class output
directories of libraries on which you depend.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The reason you modify <code>options.compilerArgs</code> inside the <code>doFirst</code> block
instead of in the configuration block of the <code>compileJava</code> task is because you
only want resolve the <code>compileClasspath</code> configuration when executing that task.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="modify_the_code_compiletestjava_code_task_to_locally_alter_the_module"><a class="anchor" href="#modify_the_code_compiletestjava_code_task_to_locally_alter_the_module"></a>Modify the <code>compileTestJava</code> task to locally alter the module</h3>
<div class="paragraph">
<p>One slightly confusing aspect of the Java 9 module system is how to run unit
tests for code inside a Java 9 module. The recommended way is to "patch" the
module during testing. Patching a module means adding extra classes to the
packages which make up the module. In the case of patching a module for running
tests, you are adding the test classes to the module, using the same package so
that the test classes have access to everything else in the module under test.</p>
</div>
<div class="paragraph">
<p>Adding the following to your <code>build.gradle</code> accomplishes this compile-time
patching of the <code>org.gradle.actors</code> module.</p>
</div>
<div class="listingblock">
<div class="title">actors/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">compileTestJava {
    inputs.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">moduleName</span><span class="delimiter">&quot;</span></span>, moduleName)
    doFirst {
        options.compilerArgs = [
            <span class="string"><span class="delimiter">'</span><span class="content">--module-path</span><span class="delimiter">'</span></span>, classpath.asPath, <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">--add-modules</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">junit</span><span class="delimiter">'</span></span>,  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">--add-reads</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>moduleName</span><span class="content">=junit</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">--patch-module</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>moduleName</span><span class="content">=</span><span class="delimiter">&quot;</span></span> + files(sourceSets.test.java.srcDirs).asPath, <i class="conum" data-value="4"></i><b>(4)</b>
        ]
        classpath = files()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the default value for the <code>classpath</code> property used as the
<code>--module-path</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Explicitly adds the automatic <code>junit</code> module to the set of observable
modules.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Declares that <code>junit</code> reads the <code>org.gradle.actors</code> module.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Adds the test source files to the <code>org.gradle.actors</code> module.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These options cause the generated class files in the <code>test</code> source set&#8217;s
<code>java.outputDir</code> to contain appropriate metadata used to patch the
<code>org.gradle.actors</code> module. Those class files are consumed in the next change.</p>
</div>
</div>
<div class="sect2">
<h3 id="modify_the_code_test_code_task_to_consume_the_locally_altered_module"><a class="anchor" href="#modify_the_code_test_code_task_to_consume_the_locally_altered_module"></a>Modify the <code>test</code> task to consume the locally altered module</h3>
<div class="paragraph">
<p>When running the tests, we have to configure the JVM that will be running the
tests to know about our modules and to patch the <code>org.gradle.actors</code> module
to include the test classes.</p>
</div>
<div class="paragraph">
<p>Add the following to the <code>build.gradle</code> file in the <code>actors</code> project.</p>
</div>
<div class="listingblock">
<div class="title">actors/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">test {
    inputs.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">moduleName</span><span class="delimiter">&quot;</span></span>, moduleName)
    doFirst {
        jvmArgs = [
            <span class="string"><span class="delimiter">'</span><span class="content">--module-path</span><span class="delimiter">'</span></span>, classpath.asPath, <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">--add-modules</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">ALL-MODULE-PATH</span><span class="delimiter">'</span></span>, <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">--add-reads</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>moduleName</span><span class="content">=junit</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">--patch-module</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>moduleName</span><span class="content">=</span><span class="delimiter">&quot;</span></span> + files(sourceSets.test.java.outputDir).asPath, <i class="conum" data-value="4"></i><b>(4)</b>
        ]
        classpath = files()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the default value for the <code>classpath</code> property at test runtime.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the special <code>ALL-MODULE-PATH</code>, because the main class of the
JVM that is running the tests is not part of a Java 9 module. It is Gradle&#8217;s
test runner, so it declares no modules it needs to consume. This argument makes
all of the modules in the module path visible.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Declares that <code>junit</code> reads the <code>org.gradle.actors</code> module.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Adds the test classes to the <code>org.gradle.actors</code> module.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point, you can actually run the tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="optional_add_code_automatic_module_name_code_manifest_entries_for_all_other_projects"><a class="anchor" href="#optional_add_code_automatic_module_name_code_manifest_entries_for_all_other_projects"></a>(Optional) - Add <code>Automatic-Module-Name</code> manifest entries for all other projects</h3>
<div class="paragraph">
<p>For backwards compatibility, Java 9&#8217;s module system allows non-module jar files
to appear on the module path. By default, these jar files are converted to
automatic modules whose names are based on the filename of the jar file. This
creates a bit of complexity though. Many jar filenames have been created without
any attempt to make the names globally unique. So it is very likely that, when
the developers responsible for maintaining some commonly used jar actually
convert that jar to a Java 9 module, they&#8217;ll choose a different module name than
the one automatically chosen for a previous non-module version of their jar.</p>
</div>
<div class="paragraph">
<p>For example, you might specify <code>requires guava</code> in a <code>module-info.java</code> file
today, but later the developers responsible for the project decide to name
their module <code>com.google.guava</code>. Now anyone who has specified <code>requires guava</code>,
or anyone who transitively depends on such a module, will have to wait for
all of the modules they depend on to change to <code>requires com.google.guava</code>
before they can adopt any of those new modules, because Java 9 only allows
one module on the module path to include any specific package.</p>
</div>
<div class="paragraph">
<p>The whole situation can get quite messy. This is why
<a href="http://blog.joda.org/2017/05/java-se-9-jpms-automatic-modules.html">Stephen Colebourne argues</a>
that we should immediately start updating all of the jars we publish to public
repositories to (at least) specify an <code>Automatic-Module-Name</code> attribute in
the jar&#8217;s manifest, and not to publish any artifacts which
contain modules that require automatic modules where that attribute has not
been specified.</p>
</div>
<div class="paragraph">
<p>So, in each <code>build.gradle</code> file for each subproject specify a <code>moduleName</code>
variable. For example:</p>
</div>
<div class="listingblock">
<div class="title">fairy/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ext.moduleName = <span class="string"><span class="delimiter">'</span><span class="content">org.gradle.fairy.app</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, in the top-level <code>build.gradle</code> file inside the <code>afterEvaluate</code> block,
tell the <code>jar</code> task to include the manifest attribute.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">        jar {
            inputs.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">moduleName</span><span class="delimiter">&quot;</span></span>, moduleName)
            manifest {
                attributes(<span class="string"><span class="delimiter">'</span><span class="content">Automatic-Module-Name</span><span class="delimiter">'</span></span>: moduleName)
            }
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it doesn&#8217;t matter what you name your jar files when you publish them to
an artifact repository like Maven Central; you&#8217;ll be sure you get the Java 9
module name you want.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You&#8217;ll be getting rid of these manifest attributes in the next step, since
you will have converted each subproject into a proper Java 9 module.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="step_1_summary"><a class="anchor" href="#step_1_summary"></a>Step 1 - Summary</h3>
<div class="paragraph">
<p>This first step is the most complicated, but now you have converted your
first <code>java-library</code> project into a Java 9 module. All of the other subprojects
consume that module on the classpath. So we haven&#8217;t really addressed any of
the modularity violations demonstrated in
<a href="#modularitytest_discussion">ModularityTest</a>, but we didn&#8217;t have to break
the project to convert one of its logical architectural units into a proper
Java 9 module. Next you&#8217;ll centralize the gradle changes into the root
<code>build.gradle</code> project, and apply it to all of the subprojects.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_2_produce_java_9_modules_for_all_subprojects"><a class="anchor" href="#step_2_produce_java_9_modules_for_all_subprojects"></a>Step 2 - Produce Java 9 modules for all subprojects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of this step is to make all of the subprojects in our Gradle build
produce Java 9 modules, and consume their dependencies as Java 9 modules. Since
you already have the <code>moduleName</code> variable declaration separate from the other
changes in the <code>build.gradle</code> file in the <code>actors</code> subproject, it&#8217;s just a
matter of cutting everything from below the <code>moduleName</code> declaration in that
file and pasting it into the <code>afterEvaluate</code> block in the root <code>build.gradle</code>
file.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">subprojects {
    afterEvaluate {
        repositories {
            jcenter()
        }

        compileJava {
            inputs.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">moduleName</span><span class="delimiter">&quot;</span></span>, moduleName)
            doFirst {
                options.compilerArgs = [
                    <span class="string"><span class="delimiter">'</span><span class="content">--module-path</span><span class="delimiter">'</span></span>, classpath.asPath,
                ]
                classpath = files()
            }
        }

        compileTestJava {
            inputs.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">moduleName</span><span class="delimiter">&quot;</span></span>, moduleName)
            doFirst {
                options.compilerArgs = [
                    <span class="string"><span class="delimiter">'</span><span class="content">--module-path</span><span class="delimiter">'</span></span>, classpath.asPath,
                    <span class="string"><span class="delimiter">'</span><span class="content">--add-modules</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">junit</span><span class="delimiter">'</span></span>,
                    <span class="string"><span class="delimiter">'</span><span class="content">--add-reads</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>moduleName</span><span class="content">=junit</span><span class="delimiter">&quot;</span></span>,
                    <span class="string"><span class="delimiter">'</span><span class="content">--patch-module</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>moduleName</span><span class="content">=</span><span class="delimiter">&quot;</span></span> + files(sourceSets.test.java.srcDirs).asPath,
                ]
                classpath = files()
            }
        }

        test {
            inputs.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">moduleName</span><span class="delimiter">&quot;</span></span>, moduleName)
            doFirst {
                jvmArgs = [
                    <span class="string"><span class="delimiter">'</span><span class="content">--module-path</span><span class="delimiter">'</span></span>, classpath.asPath,
                    <span class="string"><span class="delimiter">'</span><span class="content">--add-modules</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">ALL-MODULE-PATH</span><span class="delimiter">'</span></span>,
                    <span class="string"><span class="delimiter">'</span><span class="content">--add-reads</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>moduleName</span><span class="content">=junit</span><span class="delimiter">&quot;</span></span>,
                    <span class="string"><span class="delimiter">'</span><span class="content">--patch-module</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>moduleName</span><span class="content">=</span><span class="delimiter">&quot;</span></span> + files(sourceSets.test.java.outputDir).asPath,
                ]
                classpath = files()
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you did
<a href="#change_6_optional_add_code_atomatic_module_name_code_manifest_entries_for_all_other_projects">Change 6</a>
from Step 1, you should remove the <code>jar</code> block before pasting.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you haven&#8217;t already added <code>moduleName</code> variable declarations for each of the
subprojects, you should do that now. For example:</p>
</div>
<div class="listingblock">
<div class="title">pigs/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">ext.moduleName = <span class="string"><span class="delimiter">'</span><span class="content">org.gradle.fairy.tale.pigs</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You also need to add a <code>module-info.java</code> file for each of your subprojects.
For example:</p>
</div>
<div class="listingblock">
<div class="title">bears/src/main/java/module-info.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">module org.gradle.fairy.tale.bears {
    requires org.gradle.actors;
    requires transitive org.gradle.fairy.tale;
    requires org.gradle.fairy.tale.formula;

    exports org.gradle.fairy.tale.bears;
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
You also have to add these <code>module-info.java</code> files for the <code>pigs</code>,
<code>formula</code>, <code>fairy</code>, and <code>tale</code> subprojects. The end results should look like
the code in <code>src/2-all-modules</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now Gradle&#8217;s <code>test</code> task will fail to compile, unless you&#8217;ve
commented out the <code>canReachDefaultActor</code> test. Also, the
<code>canDynamicallyReachDefaultActor</code> test will fail at test runtime unless you
<code>@Ignore</code> it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./gradlew test

&gt; Task :formula:test

org.gradle.fairy.tale.formula.ModularityTest &gt; canDynamicallyReachDefaultActor FAILED
    java.lang.IllegalAccessException at ModularityTest.java:28

2 tests completed, 1 failed


FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':formula:test'.
&gt; There were failing tests. See the report at: &lt;link-to-report&gt;

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.

BUILD FAILED</pre>
</div>
</div>
<div class="paragraph">
<p>If you do comment out <code>canReachDefaultActor</code> and add the <code>@Ignore</code> annotation to
 <code>canDynamicallyReachDefaultActor</code>, the remaining tests should pass, and you&#8217;ll
 have exactly the code in <code>src/2-all-modules</code></p>
</div>
<div class="sect2">
<h3 id="step_2_summary"><a class="anchor" href="#step_2_summary"></a>Step 2 - Summary</h3>
<div class="paragraph">
<p>At this point in the guide, you are now compiling and running tests for all six
of the subprojects using Java 9 modules. The subprojects are appropriately
encapsulated, and none of the tests from one package can see implementation
details of any of their dependencies. However, there are a few features
of Gradle&#8217;s <a href="https://docs.gradle.org/4.2/userguide/application_plugin.html">Application Plugin</a> which are
relying on the classpath instead of the module path to load and resolve classes.</p>
</div>
<div class="paragraph">
<p>Also, Java 9 adds a more convenient way to use the <code>ServiceLoader</code> feature.
You&#8217;ll handle all of these in Step 3.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_3_consume_java_9_modules_in_the_code_run_code_and_code_assemble_code_tasks"><a class="anchor" href="#step_3_consume_java_9_modules_in_the_code_run_code_and_code_assemble_code_tasks"></a>Step 3 - Consume Java 9 modules in the <code>run</code> and <code>assemble</code> tasks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you have all of the subprojects producing Java 9 modules, it&#8217;s time to
learn how to consume those modules when running the main class
<code>org.gradle.fairy.app.StoryTeller</code> from the <code>fairy</code> project.</p>
</div>
<div class="paragraph">
<p>There are two ways run the app covered in this guide. The first is to use
Gradle&#8217;s <code>run</code> task which is added by
<a href="https://docs.gradle.org/4.2/userguide/application_plugin.html">the Application Plugin</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./gradlew run

&gt; Task :fairy:run
Once upon a time, there lived the big bad wolf, and the 3 little pigs.

&lt;... elided ...&gt;

Goldilocks ran out of the house at top speed to escape the 3 bears.
And they all lived happily ever after.


BUILD SUCCESSFUL</pre>
</div>
</div>
<div class="paragraph">
<p>The other way is to create a distribution of the application using Gradle&#8217;s
<code>assemble</code> task, then extract the distribution to some directory and run it
from there.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./gradlew assemble

BUILD SUCCESSFUL
$ cp fairy/build/distributions/fair.tar /tmp
$ cd /tmp
$ tar xvf fairy.tar
x fairy/
x fairy/lib/
x fairy/lib/fairy.jar
x fairy/lib/pigs.jar
x fairy/lib/bears.jar
x fairy/lib/formula.jar
x fairy/lib/tale.jar
x fairy/lib/actors.jar
x fairy/lib/guava-22.0.jar
x fairy/lib/jsr305-1.3.9.jar
x fairy/lib/error_prone_annotations-2.0.18.jar
x fairy/lib/j2objc-annotations-1.1.jar
x fairy/lib/animal-sniffer-annotations-1.14.jar
x fairy/bin/
x fairy/bin/fairy
x fairy/bin/fairy.bat
$ ./bin/fairy
Once upon a time, there lived the big bad wolf, and the 3 little pigs.

&lt;... elided ...&gt;

Goldilocks ran out of the house at top speed to escape the 3 bears.
And they all lived happily ever after.</pre>
</div>
</div>
<div class="paragraph">
<p>After Step 2, both of those mechanisms rely on modules which
appear on the classpath. That skips the modularity features of the Java 9
module system. In this step, you will:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the <code>run</code> task to use modules.</p>
</li>
<li>
<p>Modify the <code>startScript</code> task for both *nix and Windows to use modules.</p>
</li>
<li>
<p>Update the <code>ServiceLoader</code> mechanism to the Java 9 syntax.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once you&#8217;ve made changes 1 and 2, both mechanisms for running the program should
continue working, so feel free to run those commands again to confirm you have
correctly implemented each change.</p>
</div>
<div class="paragraph">
<p>For the impatient, you can see all of the changes together in the
<code>src/3-application</code> directory in the repository.</p>
</div>
<div class="sect2">
<h3 id="modify_the_code_run_code_task_to_use_modules"><a class="anchor" href="#modify_the_code_run_code_task_to_use_modules"></a>Modify the <code>run</code> task to use modules</h3>
<div class="paragraph">
<p>To get the <code>run</code> task working with your new Java 9 modules, add the following
to the <code>build.gradle</code> file in the <code>fairy</code> project.</p>
</div>
<div class="listingblock">
<div class="title">fairy/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">mainClassName = <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>moduleName</span><span class="content">/org.gradle.fairy.app.StoryTeller</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>

run {
    inputs.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">moduleName</span><span class="delimiter">&quot;</span></span>, moduleName)
    doFirst {
        jvmArgs = [
            <span class="string"><span class="delimiter">'</span><span class="content">--module-path</span><span class="delimiter">'</span></span>, classpath.asPath,
            <span class="string"><span class="delimiter">'</span><span class="content">--module</span><span class="delimiter">'</span></span>, mainClassName <i class="conum" data-value="2"></i><b>(2)</b>
        ]
        classpath = files()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the <code>mainClassName</code> to include the moduleName.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Explicitly tell Java 9 to use the module.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="modify_the_code_startscript_code_task_for_both_nix_and_windows_to_use_modules"><a class="anchor" href="#modify_the_code_startscript_code_task_for_both_nix_and_windows_to_use_modules"></a>Modify the <code>startScript</code> task for both *nix and Windows to use modules</h3>
<div class="paragraph">
<p>The tar and zip files created in the <code>fairy/build/distributions</code> directory
contain <a href="https://docs.gradle.org/4.2/userguide/application_plugin.html#sec:the_distribution">start scripts</a>
which allow the JVM to be started in a predictable way on all supported
operating systems.</p>
</div>
<div class="paragraph">
<p>To modify those generated <code>startScripts</code>, add the following to your
<code>fairy/build.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="title">fairy/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">startScripts {
    inputs.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">moduleName</span><span class="delimiter">&quot;</span></span>, moduleName)
    doFirst {
        classpath = files()
        defaultJvmOpts = [
            <span class="string"><span class="delimiter">'</span><span class="content">--module-path</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">APP_HOME_LIBS</span><span class="delimiter">'</span></span>,  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="string"><span class="delimiter">'</span><span class="content">--module</span><span class="delimiter">'</span></span>, mainClassName
        ]
    }
    doLast{
        <span class="keyword">def</span> bashFile = <span class="keyword">new</span> <span class="predefined-type">File</span>(outputDir, applicationName)
        <span class="predefined-type">String</span> bashContent = bashFile.text
        bashFile.text = bashContent.replaceFirst(<span class="string"><span class="delimiter">'</span><span class="content">APP_HOME_LIBS</span><span class="delimiter">'</span></span>, <span class="predefined-type">Matcher</span>.quoteReplacement(<span class="string"><span class="delimiter">'</span><span class="content">$APP_HOME/lib</span><span class="delimiter">'</span></span>))

        <span class="keyword">def</span> batFile = <span class="keyword">new</span> <span class="predefined-type">File</span>(outputDir, applicationName + <span class="string"><span class="delimiter">&quot;</span><span class="content">.bat</span><span class="delimiter">&quot;</span></span>)
        <span class="predefined-type">String</span> batContent = batFile.text
        batFile.text = batContent.replaceFirst(<span class="string"><span class="delimiter">'</span><span class="content">APP_HOME_LIBS</span><span class="delimiter">'</span></span>, <span class="predefined-type">Matcher</span>.quoteReplacement(<span class="string"><span class="delimiter">'</span><span class="content">%APP_HOME%</span><span class="char">\\</span><span class="content">lib</span><span class="delimiter">'</span></span>))
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the module path to a platform-independent placeholder value which is
later replaced in a platform-specific way for the *nix shell script and Windows
<code>.bat</code> file.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="update_the_code_serviceloader_code_mechanism_to_the_java_9_syntax"><a class="anchor" href="#update_the_code_serviceloader_code_mechanism_to_the_java_9_syntax"></a>Update the <code>ServiceLoader</code> mechanism to the Java 9 syntax</h3>
<div class="paragraph">
<p>The Java 9 module system introduces a better way to specify which modules
provide implementations of a service for the <code>ServiceLoader</code> mechanism.
First, delete the <code>resources</code> directories from both <code>bears/src/main</code> and
<code>pigs/src/main</code>, since the new mechanism doesn&#8217;t require the <code>META-INF/services</code>
files.</p>
</div>
<div class="paragraph">
<p>Then, adjust the <code>module-info.java</code> files for each of those projects.</p>
</div>
<div class="listingblock">
<div class="title">fairy/src/main/java/module-info.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">module org.gradle.fairy.app {
    requires org.gradle.fairy.tale;
    uses org.gradle.fairy.tale.Tale;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">bears/src/main/java/module-info.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">module org.gradle.fairy.tale.bears {
    requires org.gradle.actors;
    requires transitive org.gradle.fairy.tale;
    requires org.gradle.fairy.tale.formula;

    provides org.gradle.fairy.tale.Tale
        with org.gradle.fairy.tale.bears.GoldilocksAndTheThreeBears;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pigs/src/main/java/module-info.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">module org.gradle.fairy.tale.pigs {
    requires org.gradle.actors;
    requires transitive org.gradle.fairy.tale;
    requires org.gradle.fairy.tale.formula;

    provides org.gradle.fairy.tale.Tale
            with org.gradle.fairy.tale.pigs.ThreeLittlePigs;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the <code>fairy</code> project&#8217;s <code>module-info.java</code> declares that it
<code>uses org.gradle.fairy.tale.Tale</code>, the <code>ServiceLoader</code> instance will
have access to any implementations provided at runtime by Java 9 modules
that declare <code>provides org.gradle.fairy.tale.Tale</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step_4_use_the_code_experimental_jigsaw_code_plugin_to_do_the_same_thing"><a class="anchor" href="#step_4_use_the_code_experimental_jigsaw_code_plugin_to_do_the_same_thing"></a>Step 4 - Use the <code>experimental-jigsaw</code> plugin to do the same thing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While Gradle does not yet support building Java 9 modules as a first-class
feature of the Java plugins, an experimental plugin is available to allow you to
experiment with Java 9 modules on your projects.</p>
</div>
<div class="paragraph">
<p>The <code>org.gradle.java.experimental-jigsaw</code> plugin is simply a convenient
mechanism for applying all of the changes in steps 1 through 3 of this guide
in one step. It <strong>may</strong> work for your project, but you should definitely
consider it experimental and not fit for production builds.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how to use the plugin:</p>
</div>
<div class="listingblock">
<div class="title">actors/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">plugins {
    id <span class="string"><span class="delimiter">'</span><span class="content">java-library</span><span class="delimiter">'</span></span>
    id <span class="string"><span class="delimiter">'</span><span class="content">org.gradle.java.experimental-jigsaw</span><span class="delimiter">'</span></span> version <span class="string"><span class="delimiter">'</span><span class="content">0.1.1</span><span class="delimiter">'</span></span>  <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Just use <a href="https://plugins.gradle.org/plugin/org.gradle.java.experimental-jigsaw">the plugin</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>and:</p>
</div>
<div class="listingblock">
<div class="title">actors/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">javaModule.name = <span class="string"><span class="delimiter">'</span><span class="content">org.gradle.actors</span><span class="delimiter">'</span></span>  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Change the line that specifies the module name to use the new <code>javaMoudle.name</code> settings.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point, your application is taking advantage of most of the
features of the Java 9 module system. This guide has shown you how to modify
the tasks added by the regular <code>java-library</code> and <code>application</code> plugins to get
them work on with Java 9 modules. In the future, the Gradle team will be adding
first-class support for the module system, but you can begin experimenting
today!</p>
</div>
</div>
</div>
<div class="sect1 contribute">
<h2 id="help_improve_this_guide"><a class="anchor" href="#help_improve_this_guide"></a>Help improve this guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Have feedback or a question? Found a typo? Like all Gradle guides, help is just a GitHub issue away. Please add an issue or pull request to <a href="https://github.com/gradle-guides/building-java-9-modules/">gradle-guides/building-java-9-modules</a> and we&#8217;ll get back to you.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-10-09 05:51:39 +00:00
</div>
</div>
</body>
</html>